/**
 * This ruleset enforces a strict user-ownership security model for a financial
 * transaction application. The core philosophy is that all data is private and
 * belongs exclusively to the user who created it.
 *
 * Data Structure:
 * All user-specific data, such as credit card and deposit account transactions,
 * is nested within a user-specific document path: /users/{userId}/...
 * This hierarchical structure makes ownership clear and security rules simple.
 *
 * Key Security Decisions:
 * - Strict Ownership: A user can only access data (read, write, delete) if their
 *   authenticated UID matches the {userId} in the document path.
 * - No Public Data: There are no publicly readable collections. All access
 *   requires authentication.
 * - No User Listing: The rules do not allow querying the top-level `/users`
 *   collection, preventing enumeration of all application users.
 * - Path-Based Security: Authorization decisions rely on the document path,
 *   which is a fast and cost-effective strategy that avoids extra database reads
 *   (get() calls) within the rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Validates if the currently authenticated user's ID matches the
     * document's owner ID from the path. This is the primary function for
     * establishing ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Ensures that a document exists before allowing an update or delete,
     * in addition to verifying ownership. This prevents writes on documents
     * that have been deleted.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Controls access to a user's private credit card transactions.
     * @path /users/{userId}/creditCardTransactions/{transactionId}
     * @allow A user (UID 'user123') creating a new transaction for themselves. (auth.uid == 'user123', path == '/users/user123/...')
     * @deny A different user (UID 'user456') attempting to read transactions for 'user123'. (auth.uid == 'user456', path == '/users/user123/...')
     * @principle Restricts access to a user's own data tree. Only the owner can view or manage their financial data.
     */
    match /users/{userId}/creditCardTransactions/{transactionId} {
      // READ: Owner can get a single document or list all their documents.
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // WRITE: Owner can create, update, and delete their own documents.
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to a user's private deposit account transactions.
     * @path /users/{userId}/depositAccountTransactions/{transactionId}
     * @allow A user (UID 'user123') deleting one of their own transactions. (auth.uid == 'user123', path == '/users/user123/...')
     * @deny An unauthenticated user attempting to list any transactions. (auth == null)
     * @principle Restricts access to a user's own data tree. Only the owner can view or manage their financial data.
     */
    match /users/{userId}/depositAccountTransactions/{transactionId} {
      // READ: Owner can get a single document or list all their documents.
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // WRITE: Owner can create, update, and delete their own documents.
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}