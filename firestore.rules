/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model where all data is private.
 * Access to any piece of information is granted only if the authenticated user's ID matches the
 * user ID specified in the document path.
 *
 * Data Structure: All application data is segregated into user-specific subcollections. The top-level
 * 'users' collection acts as a container, with each user's data stored under a path like
 * `/users/{userId}/{collectionName}/{documentId}`. This hierarchical structure is the foundation
 * of the security model.
 *
 * Key Security Decisions:
 * - User Isolation: Users are completely isolated from one another. They cannot read, write, or even
 *   list data belonging to other users.
 * - No Public Data: All endpoints require authentication.
 * - User Enumeration Disabled: Listing the top-level `/users` collection is explicitly forbidden to
 *   prevent discovery of other users on the platform.
 * - Parent Document Lockdown: Direct access to the `/users/{userId}` document is disallowed. Its
 *   purpose is solely to group subcollections, not to store data directly. This prevents users from

 *   accidentally deleting their own root document and orphaning their data.
 *
 * Denormalization for Authorization: This ruleset leverages a path-based security model, which is highly
 * efficient. Authorization decisions are made by inspecting the document's path rather than its content.
 * Consequently, denormalizing ownership data (like a `userId` field) onto documents is unnecessary,
 * leading to simpler and more performant rules.
 *
 * Structural Segregation: User data is naturally segregated by type into distinct subcollections
 * (`creditCardTransactions`, `depositAccountTransactions`). This clean separation ensures that the
 * security posture for each data type is uniform and easy to manage, enhancing both security and
 * performance for list operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's ID matches the user ID from the path.
     * This is the primary function for enforcing data ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * A stricter version of isOwner used for updates and deletes.
     * It ensures the document exists before allowing a modification, preventing writes
     * to non-existent paths.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // --------------------------------------------------------------------------------
    // User Data Rules
    // --------------------------------------------------------------------------------

    /**
     * @description Locks down the top-level user documents. Their sole purpose is to organize subcollections.
     *   This prevents user enumeration and stops users from deleting their own root document.
     * @path /users/USER_123
     * @allow (none) - No direct operations are permitted on this path.
     * @deny A user attempting to `get` or `list` from `/users`. A user attempting to `create` their own document at `/users/USER_123`.
     * @principle Enforces strict data segregation and prevents user enumeration by disallowing listing of the root collection.
     */
    match /users/{userId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures a user's private credit card transactions. Only the user who owns this data tree can access it.
     * @path /users/USER_123/creditCardTransactions/TXN_ABC
     * @allow A user with auth.uid 'USER_123' can (create), (get), (update), or (delete) their own transaction.
     * @deny A different user with auth.uid 'USER_456' is blocked from all operations on this path.
     * @principle Restricts access to a user's own data tree. All operations are scoped to the authenticated owner.
     */
    match /users/{userId}/creditCardTransactions/{transactionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures a user's private deposit account transactions. Only the user who owns this data tree can access it.
     * @path /users/USER_123/depositAccountTransactions/TXN_XYZ
     * @allow A user with auth.uid 'USER_123' can (create), (get), (update), or (delete) their own transaction.
     * @deny A different user with auth.uid 'USER_456' is blocked from all operations on this path.
     * @principle Restricts access to a user's own data tree. All operations are scoped to the authenticated owner.
     */
    match /users/{userId}/depositAccountTransactions/{transactionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
    
    match /users/{userId}/cashTransactions/{transactionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}
