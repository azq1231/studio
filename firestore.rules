/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model where all
 * user-generated data is private. Access control is based on the user's
 * unique ID (UID) present in the document path.
 *
 * Data Structure: All data is organized hierarchically under a top-level `users`
 * collection. Each user's data, such as financial transactions, is stored in
 * subcollections within their own user document (e.g., /users/{userId}/creditCardTransactions/{transactionId}).
 * This structure provides strong, inherent security boundaries.
 *
 * Key Security Decisions:
 * - User data is strictly private. A user can only access documents under their own path (`/users/{their_uid}`).
 * - Listing all users is explicitly disallowed to protect user privacy and prevent enumeration attacks.
 * - A user is permitted to create their own root document (`/users/{userId}`), enabling profile creation.
 * - All write operations (create, update, delete) are restricted to the document owner.
 *
 * Denormalization for Authorization: The path-based security model (`/users/{userId}/...`)
 * is a form of denormalization where the user's ID is part of the path itself. This
 * avoids the need for extra `get()` calls to check ownership, resulting in faster,
 * more scalable, and more secure rules.
 *
 * Structural Segregation: User data is naturally segregated into separate document
 * trees. This is the most secure and performant way to manage private, user-specific
 * data, as queries for one user's data can never accidentally leak data from another.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Validates if the requesting user is the owner of the document based on the userId in the path.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Validates ownership for an existing resource. Used for update/delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Controls access to a user's root document.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own document: `create /users/user_abc` (auth.uid: 'user_abc').
     * @deny (list) Any user attempting to list all user documents: `list /users`.
     * @deny (get) A user trying to read another user's document: `get /users/user_xyz` (auth.uid: 'user_abc').
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);

      /**
       * @description Controls access to a user's private credit card transactions.
       * @path /users/{userId}/creditCardTransactions/{transactionId}
       * @allow (create) An owner creating a transaction in their own collection: `create /users/user_abc/creditCardTransactions/txn_123` (auth.uid: 'user_abc').
       * @allow (list) An owner listing their own transactions: `list /users/user_abc/creditCardTransactions` (auth.uid: 'user_abc').
       * @deny (get) A user trying to read another user's transaction: `get /users/user_xyz/creditCardTransactions/txn_123` (auth.uid: 'user_abc').
       * @deny (create) An owner creating a transaction with a mismatched internal ID: `create /users/user_abc/creditCardTransactions/txn_123` with data `{ "id": "txn_999" }`.
       * @principle Enforces document ownership and validates relational integrity between the document ID and its internal `id` field.
       */
      match /creditCardTransactions/{transactionId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.id == transactionId;
        allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Controls access to a user's private deposit account transactions.
       * @path /users/{userId}/depositAccountTransactions/{transactionId}
       * @allow (create) An owner creating a transaction in their own collection: `create /users/user_abc/depositAccountTransactions/txn_123` (auth.uid: 'user_abc').
       * @allow (list) An owner listing their own transactions: `list /users/user_abc/depositAccountTransactions` (auth.uid: 'user_abc').
       * @deny (get) A user trying to read another user's transaction: `get /users/user_xyz/depositAccountTransactions/txn_123` (auth.uid: 'user_abc').
       * @deny (create) An owner creating a transaction with a mismatched internal ID: `create /users/user_abc/depositAccountTransactions/txn_123` with data `{ "id": "txn_999" }`.
       * @principle Enforces document ownership and validates relational integrity between the document ID and its internal `id` field.
       */
      match /depositAccountTransactions/{transactionId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.id == transactionId;
        allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
        allow delete: if isExistingOwner(userId);
      }
    }
  }
}