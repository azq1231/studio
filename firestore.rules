/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model where all data is private to the user who created it.
 * Data Structure: All application data, including financial transactions and categories, is hierarchically organized and nested under the `/users/{userId}` path. This structure ensures that a user's data is isolated and cannot be accessed by others.
 * Key Security Decisions:
 *  - User Isolation: A user can only access documents located within their own data tree (i.e., under their own `/users/{userId}` path).
 *  - No Public Data: There are no publicly readable collections. All access requires authentication.
 *  - No User Listing: The rules do not allow for querying or listing the top-level `/users` collection.
 *  - Default Deny: Any access not explicitly granted is denied.
 * Denormalization for Authorization: The data structure itself acts as a form of denormalization for authorization. By placing all of a user's data in a subcollection under their unique user ID, we can write simple, fast, and secure rules based on the document path without needing extra database reads (`get()`) to check for ownership.
 * Structural Segregation: Credit card transactions, deposit account transactions, and categories are stored in separate, dedicated subcollections. This allows for clear, specific rules for each data type and improves query performance.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the requesting user is the owner of the document based on the path.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Checks for ownership on an existing document. Used for safe updates and deletes.
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Secures the user's private credit card transactions.
     * @path /users/{userId}/credit_card_transactions/{transactionId}
     * @allow A user (UID 'user123') can (create) their own transaction at `/users/user123/credit_card_transactions/tx_abc`.
     * @deny A different user (UID 'user456') is blocked from trying to (get) a transaction at `/users/user123/credit_card_transactions/tx_abc`.
     * @principle Restricts access to a user's own data tree, ensuring financial privacy.
     */
    match /users/{userId}/credit_card_transactions/{transactionId} {
      // READ: Only the owner can read their own transaction documents.
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // WRITE: Only the owner can create, update, or delete their own transactions.
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures the user's private deposit account transactions.
     * @path /users/{userId}/deposit_account_transactions/{transactionId}
     * @allow A user (UID 'user123') can (list) all transactions at `/users/user123/deposit_account_transactions`.
     * @deny An anonymous user is blocked from trying to (create) a transaction at `/users/user123/deposit_account_transactions/tx_def`.
     * @principle Restricts access to a user's own data tree, ensuring financial privacy.
     */
    match /users/{userId}/deposit_account_transactions/{transactionId} {
      // READ: Only the owner can read their own transaction documents.
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // WRITE: Only the owner can create, update, or delete their own transactions.
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures the user's private transaction categories.
     * @path /users/{userId}/categories/{categoryId}
     * @allow A user (UID 'user123') can (update) their own category at `/users/user123/categories/cat_food`.
     * @deny A user (UID 'user123') is blocked from trying to (delete) another user's category at `/users/user456/categories/cat_travel`.
     * @principle Restricts access to a user's own data tree, ensuring that personalization data remains private.
     */
    match /users/{userId}/categories/{categoryId} {
      // READ: Only the owner can read their own category documents.
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // WRITE: Only the owner can create, update, or delete their own categories.
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}